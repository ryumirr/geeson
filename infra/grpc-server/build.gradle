plugins {
    id 'com.google.protobuf' version '0.9.4'
}

group = 'grpc.server'
version = '0.0.1'

dependencies {
    implementation project(":application:order-app")
    implementation project(":infra:rdb:order-db")
    implementation project(":infra:queue:order-kafka")
    implementation project(":domain:order-domain")
    implementation project(":support:uuid")
    implementation project(":support:messaging")
    implementation project(":infra:uuid-impl")
    implementation project(":module:enum")

    implementation("net.devh:grpc-server-spring-boot-starter:2.15.0.RELEASE")

    // âœ… gRPC ë° protobuf core
    implementation 'io.grpc:grpc-netty-shaded:1.59.0'
    implementation 'io.grpc:grpc-protobuf:1.59.0'
    implementation 'io.grpc:grpc-stub:1.59.0'
    implementation 'com.google.protobuf:protobuf-java:3.24.4'

    // âœ… JPA ê¸°ëŠ¥ ì‚¬ìš©ì„ ìœ„í•œ í•„ìˆ˜ ì˜ì¡´ì„±
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter'

    // Optional: ë¡œê¹…/ì–´ë…¸í…Œì´ì…˜
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'javax.annotation:javax.annotation-api:1.3.2'

    // Kafka core
    implementation 'org.springframework.kafka:spring-kafka'

    // JSON ì§ë ¬í™”/ì—­ì§ë ¬í™” (Kafka message payload ì²˜ë¦¬)
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.module:jackson-module-parameter-names'

    
}

protobuf {
    protoc {
        artifact = 'com.google.protobuf:protoc:3.24.4'
    }
    plugins {
        grpc {
            artifact = 'io.grpc:protoc-gen-grpc-java:1.59.0'
        }
    }
generateProtoTasks {
    all().each { task ->
        task.builtins {
            java {
                outputSubDir = 'java'  // âœ… ë©”ì‹œì§€ í´ë˜ìŠ¤ìš©
            }
        }
        task.plugins {
            grpc {
                outputSubDir = 'grpc'  // âœ… ì„œë¹„ìŠ¤ìš©
            }
        }
    }
}
}

sourceSets {
    main {
        proto {
            srcDir 'src/main/proto'
        }
        java {
            // ğŸ’¡ ì—¬ê¸°ê°€ ì¤‘ìš”
            srcDirs = [
                'src/main/java',  // ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨!!
                'build/generated/source/proto/main/java',
                'build/generated/source/proto/main/grpc'
            ]
        }
    }
}


tasks.named('compileJava') {
    dependsOn tasks.named('generateProto')
}
tasks.named('processResources') {
    exclude('**/*.proto') // .protoëŠ” ë³µì‚¬ì—ì„œ ì œì™¸
}
